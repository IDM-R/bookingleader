<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>BOOKINGBANCHO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=RocknRoll+One&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
      background: linear-gradient(135deg, #0f2027 0%, #2c5364 100%);
      color: #fff;
      overflow-x: hidden;
    }
    .reset-btns-fixed {
      position: fixed;
      top: 18px;
      right: 22px;
      z-index: 101;
      display: flex;
      gap: 8px;
    }
    .level-reset-btn, .event-reset-btn {
      background: linear-gradient(90deg, #FFD600 0%, #d32f2f 100%);
      color: #222;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 4px 10px;
      font-size: 0.95em;
      cursor: pointer;
      box-shadow: 0 0 6px #FFD60044;
      transition: background 0.2s, color 0.2s;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
      opacity: 0.88;
    }
    .level-reset-btn:hover, .event-reset-btn:hover {
      background: linear-gradient(90deg, #d32f2f 0%, #FFD600 100%);
      color: #fff;
      opacity: 1;
    }
    .level-area {
      max-width: 900px;
      margin: 30px auto 0 auto;
      background: rgba(30,40,60,0.7);
      border-radius: 16px;
      box-shadow: 0 4px 16px #FFD60044;
      border: 2px solid #FFD600;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      gap: 24px;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
      position: relative;
    }
    .level-label {
      font-size: 1.3em;
      color: #FFD600;
      font-weight: bold;
      letter-spacing: 0.08em;
    }
    .xp-bar-bg {
      flex: 1;
      background: #222;
      border-radius: 12px;
      height: 22px;
      margin: 0 10px;
      overflow: hidden;
      position: relative;
      border: 1.5px solid #FFD600;
    }
    .xp-bar-fill {
      background: linear-gradient(90deg, #FFD600 0%, #00ffe7 100%);
      height: 100%;
      border-radius: 12px 0 0 12px;
      transition: width 0.4s;
      box-shadow: 0 0 12px #FFD60088;
    }
    .xp-bar-label {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 0; left: 0;
      color: #fff;
      font-size: 1em;
      font-weight: bold;
      text-shadow: 0 0 4px #222;
      line-height: 22px;
      pointer-events: none;
    }
    .participate-btn {
      margin-left: 10px;
      background: linear-gradient(90deg, #00ffe7 0%, #FFD600 100%);
      color: #222;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 6px 18px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 0 8px #FFD60044;
      transition: background 0.2s, color 0.2s;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
    }
    .participate-btn:hover {
      background: linear-gradient(90deg, #FFD600 0%, #00ffe7 100%);
      color: #d32f2f;
    }
    .container {
      max-width: 900px;
      margin: 40px auto 0 auto;
      padding: 30px 10px 60px 10px;
      background: rgba(30,40,60,0.7);
      border-radius: 24px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      backdrop-filter: blur(8px);
      border: 2.5px solid #FFD600;
      position: relative;
    }
    .title-main {
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
      font-size: 2.5em;
      letter-spacing: 0.13em;
      background: linear-gradient(90deg, #FFD600 0%, #00ffe7 60%, #6a82fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 16px #FFD600, 0 0 32px #00ffe7;
      font-weight: bold;
      margin: 0 0 24px 0;
      text-transform: uppercase;
      text-align: center;
    }
    .calendar-area {
      margin-bottom: 30px;
      text-align: center;
    }
    .calendar-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
      gap: 20px;
    }
    .calendar-controls button {
      background: linear-gradient(90deg, #FFD600 0%, #00ffe7 100%);
      color: #141e30;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 1.8em;
      cursor: pointer;
      box-shadow: 0 0 16px #FFD60044;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .calendar-controls button:hover {
      background: linear-gradient(90deg, #d32f2f 0%, #FFD600 100%);
      box-shadow: 0 0 24px #FFD60088;
      color: #fff;
    }
    .calendar-table {
      border-collapse: separate;
      border-spacing: 8px;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      font-size: 1.3em;
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      box-shadow: 0 4px 16px #FFD60022;
      overflow: hidden;
    }
    .calendar-table th, .calendar-table td {
      width: 13%;
      height: 60px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      background: rgba(255,255,255,0.07);
      position: relative;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
    }
    .calendar-table th {
      color: #FFD600;
      font-weight: bold;
      background: transparent;
      border: none;
      font-size: 1.1em;
      letter-spacing: 0.1em;
      box-shadow: none;
      cursor: default;
    }
    .calendar-table td.selected {
      background: linear-gradient(90deg, #FFD600 0%, #00ffe7 100%);
      color: #141e30;
      box-shadow: 0 0 16px #FFD600;
    }
    .calendar-table td.today {
      border: 2.5px solid #d32f2f;
      box-shadow: 0 0 8px #d32f2f99;
    }
    .calendar-table td.has-event::after {
      content: '';
      position: absolute;
      bottom: 8px; left: 50%;
      transform: translateX(-50%);
      width: 10px; height: 10px;
      background: #FFD600;
      border-radius: 50%;
      box-shadow: 0 0 8px #FFD600;
    }
    .calendar-table td:empty {
      background: transparent;
      cursor: default;
      box-shadow: none;
    }
    .calendar-table td.disabled-date {
      background: #222 !important;
      color: #888 !important;
      cursor: not-allowed !important;
      opacity: 0.5;
      pointer-events: none;
      box-shadow: none !important;
    }
    .inputs-area {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 18px;
      margin: 20px 0 10px 0;
      flex-wrap: wrap;
    }
    .inputs-area label {
      font-size: 1.2em;
      color: #FFD600;
      letter-spacing: 0.05em;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
    }
    .flatpickr-input {
      font-size: 1.3em;
      padding: 8px 18px;
      border-radius: 8px;
      border: 2px solid #FFD600;
      background: rgba(255,255,255,0.15);
      color: #fff;
      outline: none;
      box-shadow: 0 0 8px #FFD60055;
      transition: background 0.2s;
      width: 120px;
      letter-spacing: 0.06em;
    }
    .flatpickr-input:focus {
      background: rgba(0,255,231,0.18);
    }
    .inputs-area button {
      font-size: 1.1em;
      padding: 10px 18px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(90deg, #FFD600 0%, #00ffe7 100%);
      color: #141e30;
      font-weight: bold;
      letter-spacing: 0.05em;
      cursor: pointer;
      box-shadow: 0 0 16px #FFD60044;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .inputs-area button:hover {
      background: linear-gradient(90deg, #d32f2f 0%, #FFD600 100%);
      box-shadow: 0 0 24px #FFD60088;
      color: #fff;
    }
    .event-list {
      margin: 30px 0 10px 0;
      text-align: center;
    }
    .event-list h2 {
      font-size: 1.3em;
      color: #FFD600;
      letter-spacing: 0.05em;
      margin-bottom: 20px;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
    }
    .event-btn {
      font-size: 1.2em;
      margin: 10px 10px 0 0;
      padding: 18px 36px;
      cursor: pointer;
      border-radius: 12px;
      border: none;
      background: linear-gradient(90deg, #d32f2f 0%, #FFD600 100%);
      color: #fff;
      font-weight: bold;
      letter-spacing: 0.05em;
      box-shadow: 0 0 16px #FFD60044;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      outline: none;
      position: relative;
      border: 2px solid #FFD600;
    }
    .event-btn:hover, .event-btn:focus {
      background: linear-gradient(90deg, #FFD600 0%, #d32f2f 100%);
      box-shadow: 0 0 24px #FFD60088;
      transform: scale(1.07);
      color: #d32f2f;
    }
    .registered-list {
      margin: 40px 0 0 0;
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 0 8px #FFD60022;
      border: 2px solid #FFD600;
    }
    .registered-list h2 {
      font-size: 1.2em;
      color: #FFD600;
      margin-bottom: 10px;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
    }
    .registered-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .registered-list li {
      font-size: 1.1em;
      margin: 10px 0;
      padding: 10px 0;
      border-bottom: 1px solid #FFD60033;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
    }
    .registered-list strong {
      color: #d32f2f;
      font-weight: bold;
      letter-spacing: 0.03em;
    }
    .cancel-btn {
      color: #fff;
      background: linear-gradient(90deg, #d32f2f 0%, #FFD600 100%);
      border: none;
      border-radius: 8px;
      padding: 7px 20px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 12px #FFD60044;
      position: relative;
      z-index: 1;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
      border: 2px solid #FFD600;
    }
    .cancel-btn:hover {
      background: linear-gradient(90deg, #FFD600 0%, #d32f2f 100%);
      box-shadow: 0 0 18px #FFD600aa;
      color: #d32f2f;
    }
    .autocanceled-label {
      color: #FFD600;
      font-weight: bold;
      text-shadow: 0 0 8px #d32f2f;
      margin-left: 8px;
    }
    body, button, input {
      cursor: url('https://cdn.jsdelivr.net/gh/saint11/cursors@master/blue.cur'), auto;
    }
    /* --- è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒˆãƒ¼ã‚¹ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³çµ±ä¸€ --- */
    .modal-bg {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
    }
    .modal-bg.active { display: flex; }
    .modal-danger {
      background: linear-gradient(135deg, #22100e 60%, #d32f2f 100%);
      border: 4px solid #FFD600;
      border-radius: 20px;
      color: #fff;
      padding: 38px 32px 32px 32px;
      min-width: 330px;
      max-width: 90vw;
      box-shadow: 0 0 32px #FFD60088, 0 0 8px #d32f2f99;
      text-align: center;
      position: relative;
      animation: shake 0.6s;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
    }
    @keyframes shake {
      0% { transform: translateX(0);}
      20% { transform: translateX(-10px);}
      40% { transform: translateX(10px);}
      60% { transform: translateX(-8px);}
      80% { transform: translateX(8px);}
      100% { transform: translateX(0);}
    }
    .danger-icon {
      font-size: 3.5em;
      color: #FFD600;
      text-shadow: 0 0 18px #FFD600, 0 0 32px #fff, 0 0 8px #d32f2f;
      margin-bottom: 10px;
      animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
      from { text-shadow: 0 0 18px #FFD600, 0 0 32px #fff;}
      to { text-shadow: 0 0 32px #FFD600, 0 0 48px #fff;}
    }
    .modal-danger h3 {
      font-size: 1.7em;
      color: #FFD600;
      margin-bottom: 10px;
      font-weight: bold;
      letter-spacing: 0.06em;
      text-shadow: 0 0 12px #FFD600, 0 0 6px #d32f2f;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
    }
    .modal-danger p {
      font-size: 1.15em;
      margin-bottom: 28px;
      color: #fff;
      font-weight: bold;
      line-height: 1.7;
      letter-spacing: 0.01em;
      text-shadow: 0 0 6px #000;
    }
    .modal-danger .danger-actions {
      display: flex;
      justify-content: center;
      gap: 24px;
    }
    .danger-confirm {
      background: linear-gradient(90deg, #FFD600 0%, #d32f2f 100%);
      color: #fff;
      font-size: 1.15em;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      padding: 14px 36px;
      cursor: pointer;
      box-shadow: 0 0 16px #FFD600aa, 0 0 8px #d32f2f99;
      transition: background 0.2s, box-shadow 0.2s;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
    }
    .danger-cancel {
      background: #222;
      color: #FFD600;
      font-size: 1.15em;
      border: 2px solid #FFD600;
      border-radius: 10px;
      padding: 14px 36px;
      cursor: pointer;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
      transition: background 0.2s, color 0.2s;
    }
    .danger-confirm:hover {
      background: linear-gradient(90deg, #d32f2f 0%, #FFD600 100%);
      color: #FFD600;
    }
    .danger-cancel:hover {
      background: #FFD600;
      color: #d32f2f;
    }
    .bancho-toast {
      display: none;
      position: fixed;
      z-index: 10001;
      left: 50%; top: 18%;
      transform: translateX(-50%);
      min-width: 320px;
      background: linear-gradient(135deg, #23272b 60%, #FFD600 100%);
      color: #fff;
      border-radius: 20px;
      border: 3px solid #FFD600;
      box-shadow: 0 0 32px #FFD60088, 0 0 12px #d32f2f99;
      text-align: center;
      padding: 36px 30px 28px 30px;
      font-size: 1.3em;
      animation: fadeIn 0.4s;
      opacity: 0.98;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
    }
    .bancho-toast.show { display: block; }
    .bancho-toast .toast-icon {
      font-size: 2.8em;
      margin-bottom: 12px;
      display: block;
      color: #FFD600;
      text-shadow: 0 0 24px #FFD600, 0 0 12px #d32f2f;
      animation: sad-bounce 1s;
    }
    @keyframes sad-bounce {
      0% { transform: scale(1.3);}
      60% { transform: scale(0.9);}
      100% { transform: scale(1);}
    }
    .bancho-toast .toast-message {
      font-weight: bold;
      margin-bottom: 10px;
      color: #FFD600;
      text-shadow: 0 0 8px #d32f2f;
      font-size: 1.1em;
    }
    .bancho-toast .close-toast {
      margin-top: 8px;
      background: #FFD600;
      color: #d32f2f;
      border: none;
      border-radius: 10px;
      padding: 10px 28px;
      font-size: 1em;
      cursor: pointer;
      opacity: 0.9;
      font-family: 'RocknRoll One', 'Orbitron', 'Segoe UI', Arial, sans-serif;
      font-weight: bold;
      transition: background 0.2s, color 0.2s;
    }
    .bancho-toast .close-toast:hover {
      background: #d32f2f;
      color: #FFD600;
      opacity: 1;
    }
    @media (max-width: 700px) {
      .container { padding: 10px 2px 40px 2px; }
      .calendar-table { font-size: 1em; }
      .inputs-area { gap: 10px; flex-direction: column; }
      .event-btn { font-size: 1em; padding: 12px 16px; }
      .calendar-table th, .calendar-table td { height: 38px; }
      .reset-btns-fixed { top: 7px; right: 3vw;}
      .modal-danger { min-width: 90vw; padding: 18px 4vw 18px 4vw; }
      .bancho-toast { min-width: 90vw; padding: 18px 4vw 18px 4vw;}
    }
  </style>
</head>
<body>
  <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
  <div class="reset-btns-fixed">
    <button class="event-reset-btn" onclick="resetEvents()">ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="level-reset-btn" onclick="resetLevel()">ãƒ¬ãƒ™ãƒ«ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <!-- ãƒ¬ãƒ™ãƒ«è¡¨ç¤º -->
  <div class="level-area">
    <span class="level-label">ç•ªé•·ãƒ¬ãƒ™ãƒ«</span>
    <div class="xp-bar-bg">
      <div class="xp-bar-fill" id="xpBarFill" style="width:0%"></div>
      <div class="xp-bar-label" id="xpBarLabel"></div>
    </div>
    <span id="levelNum" style="font-size:1.2em;color:#FFD600;font-weight:bold;">Lv.1</span>
  </div>
  <div class="container">
    <div class="title-main">BOOKINGBANCHO</div>
    <div class="calendar-area">
      <div class="calendar-controls">
        <button onclick="prevMonth()">&lt;</button>
        <span id="calendarTitle" style="font-size:1.5em; font-weight:bold; letter-spacing:0.08em;"></span>
        <button onclick="nextMonth()">&gt;</button>
      </div>
      <div id="calendar"></div>
      <div class="inputs-area">
        <label>
          <span>æ™‚åˆ»ã‚’é¸æŠ</span>
          <input id="time" type="text" placeholder="æ™‚åˆ»ã‚’é¸æŠ">
        </label>
        <button onclick="aiDecideEvent()">AIã«æ±ºã‚ã¦ã‚‚ã‚‰ã†</button>
        <button onclick="showRandomEvents()">è‡ªåˆ†ã§é¸ã¶</button>
      </div>
    </div>
    <div class="event-list" id="eventList"></div>
    <div class="registered-list" id="registeredList"></div>
  </div>
  <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-bg" id="dangerModal">
    <div class="modal-danger">
      <div class="danger-icon">ğŸ”¥</div>
      <h3>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦æœ¬å½“ã«å¤§ä¸ˆå¤«ã‹ï¼Ÿ</h3>
      <p>
        <span style="color:#FFD600; font-size:1.13em;">ã“ã®æ“ä½œã€å†—è«‡ã˜ã‚ƒæ¸ˆã¾ã­ã‡ãï¼</span><br>
        <span style="color:#fff;">ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯<br><b>ç•ªé•·ã®æŸ</b>ã«åã™ã‚‹è¡Œç‚ºã ï¼</span><br>
        <span style="color:#FFD600;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™é‡‘ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚<br>ã‚ˆãè€ƒãˆã‚ã€ã‚³ãƒ©ï¼</span>
      </p>
      <div class="danger-actions">
        <button class="danger-confirm" id="dangerConfirmBtn">ãã‚Œã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹</button>
        <button class="danger-cancel" id="dangerCancelBtn">ã‚„ã£ã±ã‚„ã‚ã¨ã</button>
      </div>
    </div>
  </div>
  <!-- å…±é€šãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
  <div class="bancho-toast" id="banchoToast">
    <div class="toast-icon" id="banchoToastIcon">ğŸ¥²</div>
    <div class="toast-message" id="banchoToastMsg"></div>
    <button class="close-toast" onclick="hideBanchoToast()">é–‰ã˜ã‚‹</button>
  </div>
  <!-- Flatpickr JSï¼ˆæ™‚åˆ»ãƒ”ãƒƒã‚«ãƒ¼ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  <script>
    // Flatpickrã®åˆæœŸåŒ–ï¼ˆFirefoxå«ã‚€å…¨ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
    function setupFlatpickr() {
      flatpickr("#time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        locale: "ja",
        minuteIncrement: 5,
        allowInput: true
      });
    }
    window.addEventListener("DOMContentLoaded", setupFlatpickr);
    window.addEventListener("pageshow", setupFlatpickr);

    // --- BOOKINGBANCHOã®æ©Ÿèƒ½JS ---
    const eventXpTable = {
      "ãƒ©ãƒ³ãƒ": 10, "èª­æ›¸": 15, "æ•£æ­©": 12, "æ˜ ç”»é‘‘è³": 18, "æ–™ç†": 20,
      "ã‚«ãƒ•ã‚§ã§ä¼‘æ†©": 8, "è²·ã„ç‰©": 10, "é‹å‹•": 20, "ãƒ¨ã‚¬": 16, "å‹äººã¨ãŠèŒ¶": 10,
      "ã‚«ãƒ©ã‚ªã‚±": 14, "ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ": 13, "å…¬åœ’ã§ãƒ”ã‚¯ãƒ‹ãƒƒã‚¯": 16, "ç¾è¡“é¤¨ã«è¡Œã": 22,
      "å›³æ›¸é¤¨ã§å‹‰å¼·": 18, "éŸ³æ¥½é‘‘è³": 10, "æ‰‹èŠ¸ãƒ»DIY": 15, "å®¶ã®æƒé™¤": 12,
      "ãŠè“å­ä½œã‚Š": 15, "å†™çœŸæ’®å½±": 14
    };
    const XP_PER_LEVEL = 100;
    let user = JSON.parse(localStorage.getItem('banchoUser') || '{"xp":0,"level":1,"participated":[] }');
    let registeredEvents = JSON.parse(localStorage.getItem('registeredEvents') || '[]');
    let selectedDate = null;
    let calYear = (new Date()).getFullYear();
    let calMonth = (new Date()).getMonth();
    let cancelIdx = null;

    // å¼·åˆ¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒã‚§ãƒƒã‚¯
    function autoCancelExpiredEvents() {
      const now = new Date();
      let changed = false;
      registeredEvents.forEach(ev => {
        if (ev.status === "reserved") {
          const evDate = new Date(ev.date + "T" + ev.time);
          evDate.setMinutes(evDate.getMinutes() + 10);
          if (now > evDate) {
            ev.status = "autocanceled";
            changed = true;
          }
        }
      });
      if (changed) {
        localStorage.setItem('registeredEvents', JSON.stringify(registeredEvents));
        showBanchoToast("âš¡", "é–‹å§‹æ™‚åˆ»10åˆ†è¶…éã®ãŸã‚<br><b>ç•ªé•·åˆ¤æ–­ã§å¼·åˆ¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼</b>");
      }
    }

    function updateLevelUI() {
      document.getElementById('levelNum').textContent = `Lv.${user.level}`;
      const xpThisLevel = user.xp % XP_PER_LEVEL;
      const percent = Math.min(100, (xpThisLevel / XP_PER_LEVEL) * 100);
      document.getElementById('xpBarFill').style.width = percent + '%';
      document.getElementById('xpBarLabel').textContent = `${xpThisLevel} / ${XP_PER_LEVEL} XP`;
    }

    function showBanchoToast(icon, msg, duration=4000) {
      const toast = document.getElementById('banchoToast');
      document.getElementById('banchoToastIcon').textContent = icon;
      document.getElementById('banchoToastMsg').innerHTML = msg;
      toast.classList.add('show');
      toast.style.opacity = 1;
      if (toast._timer) clearTimeout(toast._timer);
      toast._timer = setTimeout(hideBanchoToast, duration);
    }
    function hideBanchoToast() {
      const toast = document.getElementById('banchoToast');
      toast.style.opacity = 0;
      setTimeout(()=>{toast.classList.remove('show');}, 400);
    }

    function addXp(xp, eventName) {
      let beforeLevel = user.level;
      user.xp += xp;
      user.level = Math.floor(user.xp / XP_PER_LEVEL) + 1;
      localStorage.setItem('banchoUser', JSON.stringify(user));
      updateLevelUI();
      if (user.level > beforeLevel) {
        showBanchoToast("ğŸ’¥", `ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼<br>ã€Œ${eventName}ã€ã§${xp}XPç²å¾—<br>ç•ªé•·ãƒ¬ãƒ™ãƒ«ãŒLv.${user.level}ã«ãªã£ãŸï¼`);
      } else {
        showBanchoToast("ğŸ”¥", `ã€Œ${eventName}ã€ã«å‚åŠ ï¼<br>+${xp}XPã‚²ãƒƒãƒˆï¼`);
      }
    }

    function renderCalendar(year, month) {
      const calendarDiv = document.getElementById('calendar');
      const calendarTitle = document.getElementById('calendarTitle');
      calendarDiv.innerHTML = '';
      const today = new Date();
      today.setHours(0,0,0,0);
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const weeks = [];
      let week = [];
      for (let i = 0; i < firstDay.getDay(); i++) week.push('');
      for (let d = 1; d <= lastDay.getDate(); d++) {
        week.push(d);
        if (week.length === 7) {
          weeks.push(week);
          week = [];
        }
      }
      if (week.length > 0) {
        while (week.length < 7) week.push('');
        weeks.push(week);
      }
      let html = '<table class="calendar-table"><tr><th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th></tr>';
      for (const w of weeks) {
        html += '<tr>';
        for (const d of w) {
          let cls = '';
          let dateStr = '';
          let isPast = false;
          if (d) {
            dateStr = `${year}-${('0'+(month+1)).slice(-2)}-${('0'+d).slice(-2)}`;
            const cellDate = new Date(year, month, d);
            cellDate.setHours(0,0,0,0);
            if (cellDate < today) {
              cls += ' disabled-date';
              isPast = true;
            }
            if (selectedDate === dateStr) cls += ' selected';
            if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === d) cls += ' today';
            if (registeredEvents.some(ev => ev.date === dateStr)) cls += ' has-event';
            html += `<td class="${cls}" tabindex="${isPast ? '-1' : '0'}" ${isPast ? '' : `onclick="selectDate('${dateStr}')" onkeydown="if(event.key==='Enter'){selectDate('${dateStr}');}"`}>${d}</td>`;
          } else {
            html += '<td></td>';
          }
        }
        html += '</tr>';
      }
      html += '</table>';
      calendarDiv.innerHTML = html;
      calendarTitle.textContent = `${year}å¹´${month+1}æœˆ`;
    }
    function prevMonth() { calMonth--; if(calMonth<0){calMonth=11;calYear--;} renderCalendar(calYear,calMonth);}
    function nextMonth() { calMonth++; if(calMonth>11){calMonth=0;calYear++;} renderCalendar(calYear,calMonth);}
    function selectDate(dateStr) { selectedDate = dateStr; renderCalendar(calYear, calMonth); }

    function getRandomEvents(arr, n) {
      const shuffled = arr.slice().sort(() => 0.5 - Math.random());
      return shuffled.slice(0, n);
    }

    function createGoogleCalUrl(title, date, time) {
      const start = date.replace(/-/g, '') + 'T' + time.replace(':', '') + '00';
      let [h, m] = time.split(':');
      let endH = ('0' + (parseInt(h, 10) + 1)).slice(-2);
      const end = date.replace(/-/g, '') + 'T' + endH + m + '00';
      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${start}/${end}`;
    }

    function aiDecideEvent() {
      const time = document.getElementById('time').value;
      if (!selectedDate || !time) {
        alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã¨æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      const today = new Date();
      today.setHours(0,0,0,0);
      const selDate = new Date(selectedDate);
      selDate.setHours(0,0,0,0);
      if (selDate < today) {
        alert('éå»ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“ã€‚');
        return;
      }
      const eventNames = Object.keys(eventXpTable);
      const rndIdx = Math.floor(Math.random() * eventNames.length);
      const event = eventNames[rndIdx];
      registeredEvents.push({date: selectedDate, time: time, event: event, status: "reserved"});
      localStorage.setItem('registeredEvents', JSON.stringify(registeredEvents));
      showRegisteredEvents();
      renderCalendar(calYear, calMonth);
      const url = createGoogleCalUrl(event, selectedDate, time);
      window.open(url, '_blank');
      showBanchoToast("ğŸ¤–", `AIç•ªé•·ãŒé¸ã‚“ã ã‚¤ãƒ™ãƒ³ãƒˆã¯â€¦<br><b>${event}</b> ã ï¼<br>æ¥½ã—ã‚“ã§ã“ã„ã‚ˆï¼`);
    }

    function showRandomEvents() {
      const time = document.getElementById('time').value;
      if (!selectedDate || !time) {
        alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã¨æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      const today = new Date();
      today.setHours(0,0,0,0);
      const selDate = new Date(selectedDate);
      selDate.setHours(0,0,0,0);
      if (selDate < today) {
        alert('éå»ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“ã€‚');
        return;
      }
      const randomEvents = getRandomEvents(Object.keys(eventXpTable), 5);
      const eventList = document.getElementById('eventList');
      eventList.innerHTML = '<h2>ã‚¤ãƒ™ãƒ³ãƒˆå€™è£œï¼ˆ1ã¤é¸ã‚“ã§ãã‚Œã‚ˆãªï¼‰</h2>';
      randomEvents.forEach(event => {
        const btn = document.createElement('button');
        btn.textContent = event + ` (+${eventXpTable[event]}XP)`;
        btn.className = 'event-btn';
        btn.onclick = () => {
          registeredEvents.push({date: selectedDate, time: time, event: event, status: "reserved"});
          localStorage.setItem('registeredEvents', JSON.stringify(registeredEvents));
          showRegisteredEvents();
          renderCalendar(calYear, calMonth);
          const url = createGoogleCalUrl(event, selectedDate, time);
          window.open(url, '_blank');
        };
        eventList.appendChild(btn);
      });
    }

    function participateEvent(idx) {
      const ev = registeredEvents[idx];
      if (!ev || ev.status === "done" || ev.status === "canceled" || ev.status === "autocanceled") return;
      ev.status = "done";
      localStorage.setItem('registeredEvents', JSON.stringify(registeredEvents));
      addXp(eventXpTable[ev.event] || 10, ev.event);
      showRegisteredEvents();
    }

    function showRegisteredEvents() {
      autoCancelExpiredEvents();
      const list = document.getElementById('registeredList');
      if (registeredEvents.length === 0) {
        list.innerHTML = '<h2>ç™»éŒ²æ¸ˆã¿ã‚¤ãƒ™ãƒ³ãƒˆ</h2><p>ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }
      let html = '<h2>ç™»éŒ²æ¸ˆã¿ã‚¤ãƒ™ãƒ³ãƒˆ</h2><ul>';
      const now = new Date();
      registeredEvents.forEach((ev, idx) => {
        let statusStr = "";
        if (ev.status === "done") statusStr = ' <span style="color:#00ffe7;">[å‚åŠ æ¸ˆ]</span>';
        if (ev.status === "canceled") statusStr = ' <span style="color:#d32f2f;">[ã‚­ãƒ£ãƒ³ã‚»ãƒ«]</span>';
        if (ev.status === "autocanceled") statusStr = ' <span class="autocanceled-label">[å¼·åˆ¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«]</span>';
        html += `<li>${ev.date} ${ev.time} <strong>${ev.event}</strong> +${eventXpTable[ev.event] || 10}XP${statusStr}`;
        const eventDateTime = new Date(ev.date + "T" + ev.time);
        // å‚åŠ ãƒœã‚¿ãƒ³: statusãŒreservedã‹ã¤ä»ŠãŒã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹æ™‚åˆ»ä»¥é™ã‹ã¤å¼·åˆ¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãªã„
        if (ev.status === "reserved" && eventDateTime <= now) {
          html += `<button class="participate-btn" onclick="participateEvent(${idx})">å‚åŠ </button>`;
        }
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³: statusãŒreservedãªã‚‰å¸¸ã«è¡¨ç¤º
        if (ev.status === "reserved") {
          html += `<button class="cancel-btn" onclick="openDangerModal(${idx})">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`;
        }
        html += `</li>`;
      });
      html += '</ul>';
      list.innerHTML = html;
    }

    function openDangerModal(idx) {
      cancelIdx = idx;
      document.getElementById('dangerModal').classList.add('active');
      setTimeout(()=>{document.getElementById('dangerConfirmBtn').focus();}, 100);
    }
    function closeDangerModal() {
      document.getElementById('dangerModal').classList.remove('active');
      cancelIdx = null;
    }
    document.getElementById('dangerCancelBtn').onclick = closeDangerModal;
    document.getElementById('dangerConfirmBtn').onclick = function() {
      if (cancelIdx !== null) {
        registeredEvents[cancelIdx].status = "canceled";
        localStorage.setItem('registeredEvents', JSON.stringify(registeredEvents));
        showRegisteredEvents();
        renderCalendar(calYear, calMonth);
        closeDangerModal();
        showBanchoToast("ğŸ¥²", "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’ç¢ºå®šã—ã¾ã—ãŸ<br><span style='font-size:0.95em;'>ç•ªé•·ã¯ãŒã£ã‹ã‚Šã—ã¦ã‚‹ãŒã€ã¾ãŸã®ã”åˆ©ç”¨ã‚’å¾…ã£ã¦ã‚‹ãœâ€¦</span>");
      }
    };

    function resetEvents() {
      if(confirm("æœ¬å½“ã«ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        registeredEvents = [];
        localStorage.setItem('registeredEvents', JSON.stringify(registeredEvents));
        showRegisteredEvents();
        renderCalendar(calYear, calMonth);
        showBanchoToast("ğŸ—‘ï¸", "ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸãœï¼<br><span style='font-size:0.95em;'>ã¾ãŸæ–°ãŸãªä¼èª¬ã‚’ä½œã‚ã†ã˜ã‚ƒã­ã‡ã‹ï¼</span>");
      }
    }
    function resetLevel() {
      if(confirm("æœ¬å½“ã«ç•ªé•·ãƒ¬ãƒ™ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        user = {xp:0, level:1, participated:[]};
        localStorage.setItem('banchoUser', JSON.stringify(user));
        updateLevelUI();
        showBanchoToast("ğŸ”„", "ç•ªé•·ãƒ¬ãƒ™ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸãœï¼<br><span style='font-size:0.95em;'>ã¾ãŸã‚¤ãƒã‹ã‚‰æˆã‚Šä¸ŠãŒã‚Œï¼</span>");
      }
    }

    // åˆæœŸåŒ–æ™‚ã«å¼·åˆ¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒã‚§ãƒƒã‚¯
    autoCancelExpiredEvents();
    updateLevelUI();
    renderCalendar(calYear, calMonth);
    showRegisteredEvents();

    // å®šæœŸçš„ã«å¼·åˆ¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«åˆ¤å®šï¼ˆ1åˆ†ã”ã¨ï¼‰
    setInterval(() => {
      autoCancelExpiredEvents();
      showRegisteredEvents();
    }, 60000);

    window.participateEvent = participateEvent;
    window.openDangerModal = openDangerModal;
    window.resetEvents = resetEvents;
    window.resetLevel = resetLevel;
    window.aiDecideEvent = aiDecideEvent;
    window.showRandomEvents = showRandomEvents;
  </script>
</body>
</html>
